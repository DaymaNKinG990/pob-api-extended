# Анализ непокрытых строк и варианты покрытия

## Общая статистика
- **Общее покрытие:** 99% (48 непокрытых строк из 4736)
- **item_modifier_parser.py:** 90% (36 строк)
- **interfaces.py:** 74% (10 строк - ellipsis в Protocol)

---

## 1. calculator/item_modifier_parser.py (36 строк)

### Строки 357-367: TO_MAXIMUM_PATTERN
**Проблема:** Паттерн `TO_MAXIMUM_PATTERN` проверяется после `FLAT_PATTERN`, поэтому строка "+50 to maximum Life" попадает в `FLAT_PATTERN` раньше.

**Варианты решения:**
1. ✅ **Использовать строку без "+"**: "50 to maximum Life" (но это не сработает, так как паттерн требует "+")
2. ✅ **Использовать другой формат**: "+50 to maximum Energy Shield" или "+50 to maximum Mana"
3. ✅ **Переместить TO_MAXIMUM_PATTERN выше FLAT_PATTERN** (но это может сломать логику)
4. ✅ **Создать тест с моком, который пропускает FLAT_PATTERN**

**Рекомендация:** Вариант 2 - использовать строку, которая точно попадет в TO_MAXIMUM_PATTERN, например "+50 to maximum Energy Shield" или "+50 to maximum Mana".

### Строки 411-412: else branch в TO_ALL_PATTERN
**Проблема:** Это else ветка для не-resistance статов в паттерне "X to all Y".

**Варианты решения:**
1. ✅ **Использовать строку "+10 to all Attributes"** - должна попасть в else ветку
2. ✅ **Использовать "+10 to all Stats"** или другие не-resistance статы

**Рекомендация:** Вариант 1 - протестировать с "+10 to all Attributes".

### Строки 499-515: PER_STAT_PATTERN
**Проблема:** Паттерн "X% increased Y per Z Attribute" может не покрываться тестами.

**Варианты решения:**
1. ✅ **Использовать строку "1% increased Damage per 10 Strength"**
2. ✅ **Использовать другие варианты**: "2% increased Life per 10 Dexterity", "3% increased Energy Shield per 10 Intelligence"

**Рекомендация:** Вариант 1 - добавить тест с "1% increased Damage per 10 Strength".

### Строки 603-614, 640-651, 661-670, 680-689, 699-708, 718-727, 737-746, 756-765, 775-784, 794-803, 813-822: Chance patterns с recently_condition
**Проблема:** Это блоки создания модификаторов в chance patterns. Возможно, тесты не покрывают случаи, когда `recently_condition` может быть `None` или не `None`.

**Варианты решения:**
1. ✅ **Добавить тесты с recently_condition = None** (когда условие не найдено в recently_mappings)
2. ✅ **Добавить тесты с recently_condition != None** (когда условие найдено)
3. ✅ **Покрыть все комбинации**: effect + recently_condition для каждого паттерна

**Рекомендация:** Вариант 3 - добавить тесты для всех комбинаций эффектов и recently условий.

### Строки 932, 937: _match_effect fallback логика
**Проблема:** Это fallback логика в функции `_match_effect`, которая проверяет, если ключ в эффекте или эффект в ключе.

**Варианты решения:**
1. ✅ **Использовать эффект, который не совпадает напрямую, но совпадает через fallback**: например, "freeze enemy" (содержит "freeze")
2. ✅ **Использовать эффект, который является подстрокой ключа**: например, "to" (содержится в "to freeze")

**Рекомендация:** Вариант 1 - добавить тест с эффектом, который совпадает через fallback логику.

---

## 2. interfaces.py (10 строк)

### Строки 27, 42, 110, 115, 120, 125, 130, 135, 140, 145: Ellipsis в Protocol методах
**Проблема:** Это ellipsis (`...`) в Protocol методах, которые технически невозможно покрыть напрямую, так как это только сигнатуры интерфейсов.

**Варианты решения:**
1. ❌ **Прямое покрытие невозможно** - ellipsis не выполняется как код
2. ✅ **Косвенное покрытие через использование** - уже сделано через тесты с mock и реальными объектами
3. ✅ **Использовать `# pragma: no cover`** для этих строк (стандартная практика для Protocol)
4. ✅ **Использовать `# type: ignore` с комментарием** о том, что это Protocol сигнатура

**Рекомендация:** Вариант 3 - добавить `# pragma: no cover` для ellipsis в Protocol методах, так как это стандартная практика и технически невозможно покрыть эти строки.

---

## План действий

### Приоритет 1: Легко исправимые (item_modifier_parser.py)
1. ✅ Добавить тест для TO_MAXIMUM_PATTERN с правильной строкой
2. ✅ Добавить тест для TO_ALL_PATTERN else branch
3. ✅ Добавить тест для PER_STAT_PATTERN
4. ✅ Добавить тесты для chance patterns с recently_condition = None
5. ✅ Добавить тест для _match_effect fallback логики

### Приоритет 2: Protocol методы (interfaces.py)
1. ✅ Добавить `# pragma: no cover` для ellipsis в Protocol методах

### Ожидаемый результат
- **item_modifier_parser.py:** 90% → ~95-98% (останутся только редкие edge cases)
- **interfaces.py:** 74% → 100% (с pragma: no cover)
- **Общее покрытие:** 99% → ~99.5-99.8%
